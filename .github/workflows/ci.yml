name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build:
    # https://github.com/actions/runner-images/tree/main/images/macos
    runs-on: macos-26
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode 26.0
        run: |
          ls -1 /Applications | grep -E '^Xcode_26\.' || true
          sudo xcode-select -s "/Applications/Xcode_26.0.app"
          xcodebuild -version
          xcrun simctl list runtimes

      - name: Create Debug.xcconfig
        run: cp ./BuildConfiguration/Debug.template.xcconfig ./BuildConfiguration/Debug.xcconfig

      - name: Resolve SPM dependencies
        run: xcodebuild -resolvePackageDependencies

      - name: Reset Simulator
        run: |
          set -x
          export DEVELOPER_DIR="/Applications/Xcode_26.0.app"
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true
          launchctl kickstart -k gui/$UID/com.apple.CoreSimulator.CoreSimulatorService || true
          xcrun simctl list devices || true

      - name: Build for testing
        run: |
          xcodebuild \
            -scheme BookPlayer \
            -configuration Debug \
            -destination "platform=iOS Simulator,name=iPhone 17,OS=26.1" \
            build-for-testing

      - name: Run unit tests
        timeout-minutes: 12
        env:
          NSUnbufferedIO: "YES"
        run: |
          xcodebuild \
            -scheme BookPlayer \
            -configuration Debug \
            -testPlan "Unit Tests" \
            -only-testing:BookPlayerTests \
            -destination "platform=iOS Simulator,name=iPhone 17,OS=26.1" \
            -destination-timeout 120 \
            test-without-building
